{% extends "bootstrap/base.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% import "bootstrap/fixes.html" as fixes %}
{% import "bootstrap/utils.html" as util %}

{% block styles %}
{{super()}}
<style>
.footer {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 20px;
}
.centered {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}
#error {
    font-size: 14pt;
    background-color: #FFA5A5;
    display: none;
    padding: 10px 20px;
    border-radius: 2px;
}

td { white-space: nowrap; }
</style>
<link rel="stylesheet" type="text/css" href="http://cdn.datatables.net/1.10.7/css/jquery.dataTables.min.css">
{% endblock %}

{% block content %}
<div class="container" style="width:90%">

    <div class="col-md-6">
        <div class="row">
            <div class="col-md-4">
                <a href="/">
                    <img class="img-responsive" src="https://raw.githubusercontent.com/job/irrexplorer/master/docs/irrexplorer-logo.png" />
                </a>
            </div>
            <div class="col-md-1">
            </div>
            <div class="col-md-7">
                <div class="row">&nbsp;
                </div>
                <form id="form" class="form-inline">
                    <h2>AS macro</h2><input type="text" name="as_macro" class="form-control" />
                    <button id="btnsearch" type="submit" class="btn btn-primary" name="search" value="Search">Search</button>
                </form>
            </div>
        </div>

        <div class="row">&nbsp;</div>

        <h4>Macro expansion:</h4>

        <div class="row">
            <div>

                    <div class="row" id="loading" style="display:none">
                        <div class="col-md-2 col-md-offset-5"><img src="/static/img/loading.gif"/></div>
                    </div>
                <table id="expanded" class="display" cellspacing="0" width="100%"></table>
                <div id="error"></div>

            </div>
            <div>Note: Expansion is limited to 1000 macros due to performance reasons.</div>
        </div>

        <div class="row">&nbsp;</div>

        <h4>Contained in the following macros: </h4>

        <div class="row">
            <div>

                    <div class="row" id="loading" style="display:none">
                        <div class="col-md-2 col-md-offset-5"><img src="/static/img/loading.gif"/></div>
                    </div>
                <table id="macros" class="display" cellspacing="0" width="100%"></table>
                <div id="error"></div>

            </div>
        </div>

    </div>

</div>
<div>
    <div class="pull-right">
        Source code available on <a href="https://github.com/job/irrexplorer">Github</a>.
    </div>
</div>


{% endblock %}

{% block scripts %}
{{super()}}
<script type="text/javascript" src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="/static/js/table.js"></script>
<script type="text/javascript">
// source: https://github.com/h5bp/html5-boilerplate/blob/master/src/js/plugins.js
// Avoid `console` errors in browsers that lack a console.
(function() {
    var method;
    var noop = function () {};
    var methods = [
        'assert', 'clear', 'count', 'debug', 'dir', 'dirxml', 'error',
        'exception', 'group', 'groupCollapsed', 'groupEnd', 'info', 'log',
        'markTimeline', 'profile', 'profileEnd', 'table', 'time', 'timeEnd',
        'timeline', 'timelineEnd', 'timeStamp', 'trace', 'warn'
    ];
    var length = methods.length;
    var console = (window.console = window.console || {});

    while (length--) {
        method = methods[length];

        // Only stub undefined methods.
        if (!console[method]) {
            console[method] = noop;
        }
    }
}());

$(document).ready(function () {

    // look at what is after /as_macro/ in the URL
    // if something is present then search straight away
    as_macro_url = "";
    var pathArray = window.location.pathname.split( '/' );
    if (pathArray[pathArray.length - 1 ] != "as_macro") {
        if (pathArray[pathArray.length - 2] == "as_macro") {
            as_macro_url = pathArray[pathArray.length - 1];
        }
        if (pathArray[pathArray.length - 3] == "as_macro") {
            as_macro_url = pathArray[pathArray.length - 2] + "/" + pathArray[pathArray.length - 1];
        }
    };
    if (as_macro_url != "") {
        $('form').find('input[name="as_macro"]').val(as_macro_url);
        as_macro_search();
    };

    $("form").submit(function (e) {
        e.preventDefault(); //prevent default form submit
        window.location.href = '/as_macro/' + $('form').find('input[name="as_macro"]').val();
    });

});

function as_macro_search() {
    var as_macro = $('form').find('input[name="as_macro"]').val();
    console.log("as_macro: " + as_macro);
    if (as_macro.length > 0)
    {
        state_loading();
        $.ajax({
            url: '/as_macro_json/' + as_macro,
            success: function (data) {
                state_loaded();
                result = JSON.parse(data);
                populatetable('#expanded', result['expanded'], ["as_macro", "depth", "path", "source", "members"] );
                populatetable('#macros', result['macros'], ["as_macro"] );
            },
            error: function(error) {
                state_loaded();
                errMsg = $(error.responseText).filter("p").text();
                console.log(errMsg);
                $("#error").text(errMsg);
                $("#error").show()
            },
            cache: false
        });
    };
}

</script>
{% endblock %}

{% block head %}
{{super()}}
{{fixes.ie8()}}

{% endblock %}

{% extends "bootstrap/base.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% import "bootstrap/fixes.html" as fixes %}
{% import "bootstrap/utils.html" as util %}

{% block styles %}
{{super()}}
<style>
.footer {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 20px;
}
.centered {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}
#error {
    font-size: 14pt;
    background-color: #FFA5A5;
    display: none;
    padding: 10px 20px;
    border-radius: 2px;
}

td { white-space: nowrap; }
</style>
<link rel="stylesheet" type="text/css" href="http://cdn.datatables.net/1.10.7/css/jquery.dataTables.min.css">
{% endblock %}

{% block content %}
<div class="container" style="width:90%">

    <div class="col-md-6">
        <div class="row">
            <div class="col-md-4">
                <img class="img-responsive" src="https://raw.githubusercontent.com/job/irrexplorer/master/docs/irrexplorer-logo.png" />
            </div>
            <div class="col-md-1">
            </div>
            <div class="col-md-7">
                <div class="row">&nbsp;
                </div>
                <form id="form" class="form-inline">
                    <h2>AS number</h2><input type="text" name="asn" class="form-control" />
                    <button id="btnsearch" type="submit" class="btn btn-primary" name="search" value="Search">Search</button>
                </form>
            </div>
        </div>

        <div class="row">&nbsp;</div>

        <h4>Prefixes:</h4>

        <div class="row">
            <div>

                    <div class="row" id="loading" style="display:none">
                        <div class="col-md-2 col-md-offset-5"><img src="/static/img/loading.gif"/></div>
                    </div>
                <table id="prefixes" class="display" cellspacing="0" width="100%"></table>
                <div id="error"></div>

            </div>
        </div>

        <div class="form-group">&nbsp;</div>

        <h4>Contained in the following macros: </h4>

        <div class="row">
            <div>

                    <div class="row" id="loading" style="display:none">
                        <div class="col-md-2 col-md-offset-5"><img src="/static/img/loading.gif"/></div>
                    </div>
                <table id="macros" class="display" cellspacing="0" width="100%"></table>
                <div id="error"></div>

            </div>
        </div>

    </div>

</div>
<div>
    <div class="pull-right">
        Source code available on <a href="https://github.com/job/irrexplorer">Github</a>.
    </div>
</div>


{% endblock %}

{% block scripts %}
{{super()}}
<script type="text/javascript" src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="//cdn.datatables.net/plug-ins/1.10.7/sorting/ip-address.js"></script>
<script type="text/javascript">
// source: https://github.com/h5bp/html5-boilerplate/blob/master/src/js/plugins.js
// Avoid `console` errors in browsers that lack a console.
(function() {
    var method;
    var noop = function () {};
    var methods = [
        'assert', 'clear', 'count', 'debug', 'dir', 'dirxml', 'error',
        'exception', 'group', 'groupCollapsed', 'groupEnd', 'info', 'log',
        'markTimeline', 'profile', 'profileEnd', 'table', 'time', 'timeEnd',
        'timeline', 'timelineEnd', 'timeStamp', 'trace', 'warn'
    ];
    var length = methods.length;
    var console = (window.console = window.console || {});

    while (length--) {
        method = methods[length];

        // Only stub undefined methods.
        if (!console[method]) {
            console[method] = noop;
        }
    }
}());

$(document).ready(function () {

    // look at what is after /asn/ in the URL
    // if something is present then search straight away
    asn_url = "";
    var pathArray = window.location.pathname.split( '/' );
    if (pathArray[pathArray.length - 1 ] != "asn") {
        if (pathArray[pathArray.length - 2] == "asn") {
            asn_url = pathArray[pathArray.length - 1];
        }
        if (pathArray[pathArray.length - 3] == "asn") {
            asn_url = pathArray[pathArray.length - 2] + "/" + pathArray[pathArray.length - 1];
        }
    };
    if (asn_url != "") {
        $('form').find('input[name="asn"]').val(asn_url);
        asn_search();
    };

    $("form").submit(function (e) {
        e.preventDefault(); //prevent default form submit
        window.location.href = '/asn/' + $('form').find('input[name="asn"]').val();
        //asn_search();
    });

});

function state_loaded() {
    $("#btnsearch").prop("disabled",false); 
    $("#loading").hide();
    $("#btnsearch").html('Search');  
}

function state_loading() {
    $("#btnsearch").prop("disabled",true);
    $("#btnsearch").html('Searching...');
    $("#loading").show();
}

function asn_search() {
    var asn = $('form').find('input[name="asn"]').val();
        if (asn.length > 0)
        {
            state_loading();
            $.ajax({
                url: '/asn_json/' + asn,
                success: function (data) {
                    state_loaded();
                    result = JSON.parse(data);
                    prefixes = result['prefixes'];
                    macros = result['macros'];
                    populatetable('#prefixes', prefixes, ["prefix", "bgp"] );
                    populatetable('#macros', macros, ["macro"] );
                },
                error: function(error) {
                    state_loaded();
                    errMsg = $(error.responseText).filter("p").text();
                    console.log(errMsg);
                    $("#error").text(errMsg);
                    $("#error").show()
                },
                cache: false
            });
        };
}


function renderCell(data) {

    if (typeof data != 'undefined') {
        switch (data.toString()) {
            case "true":
                return "<img alt='T' title='True' src='/static/img/true.png'>";
            case "false":
                return "<img alt='F' title='False' src='/static/img/false.png'>";
            default:
                return data;
        }
    } else {
        return "";
    }
}

function getfields(table_data, start_fields) {

    var table_keys = Object.keys(table_data);

    var fields = start_fields.slice(0); // clone

    for (var idx in table_keys) {
        var key = table_keys[idx];
        var table_entry = table_data[key];

        var entry_fields = Object.keys(table_entry);

        for (var efi in entry_fields) {
            field_name = entry_fields[efi];
            if (fields.indexOf(field_name) == -1) {
                fields.push(field_name);
            }
        }
    }

    return fields;
}

function populatetable(table_name, table_data, start_fields) {

    console.log("populate table: " + table_name);
    console.log(table_data);
    console.log(start_fields);
    console.log("--");

    fields = getfields(table_data, start_fields);
    console.log(fields);

    $(table_name).hide();

    rows = [];
    table_keys = Object.keys(table_data);

    console.log(table_keys);

    for (var idx in table_keys) {
        key = table_keys[idx];

        table_entry = table_data[key];
        row = [];
        for (var f in fields) {
            field = fields[f];
            if (field == start_fields[0]) {
                row.push('<a href="/' + start_fields[0] + '/' + key + '">' + key + '</a>');
            } else {
                row.push(renderCell(table_entry[field]))
            }
        }
        rows.push(row);
    };

    colsdisp = [];
    for (var f in fields) {
        field = fields[f];
        coldisp = {"title": field}
        colsdisp.push(coldisp);
    }
    if ( ! $.fn.DataTable.isDataTable(table_name) ) {
        $(table_name).dataTable( {
                "data": rows,
                "columns": colsdisp,
                "searching": false,
                "lengthChange": false,
                "bPaginate": false,
                "columnDefs": [ { 'type': 'ip-address', 'targets': 0 } ]
            } );
    } else {
        // just update, already set the table up once
        $(table_name).dataTable().fnClearTable();
        $(table_name).dataTable().fnAddData(rows);

    }

    $(table_name).show();
}

</script>
{% endblock %}

{% block head %}
{{super()}}
{{fixes.ie8()}}

{% endblock %}
